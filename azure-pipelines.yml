schedules:
  - cron: "30 06 * * *"
    displayName: Daily build
    branches:
      include:
        - master
    always: true

jobs:
  - job: RunPytests
    timeoutInMinutes: 40
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.7'
        displayName: 'Use Python 3.7'

      - script: pip install -r requirements.txt; pip install -e .
        displayName: 'Install dependencies'

      - script: ddc-services up -d
        displayName: 'Start services'

      - script: |
          set -ex
          cd tests/fixtures/forum/
          ddc-project config
          ddc-project up -d lms forum
        displayName: 'Start lms and forum'

      - script: derex reset-rabbitmq; derex reset-mysql
        displayName: 'Prime Mysql and rabbitmq'

      - script: |
          set -ex
          cd tests/fixtures/forum/
          ddc-project logs
        displayName: 'Show logs'
