steps:
  - script: |
      IMAGE="derex/forum-$(OPENEDX_VERSION):$(grep __version__ derex/forum/__init__.py |sed 's/[^"]*"//;s/"//')"
      echo Checking presence of ${IMAGE} on docker registry
      docker manifest inspect ${IMAGE} || { echo '##vso[task.setvariable variable=needs_push]true'; echo Image not found: pushing ; }
    displayName: "Set needs_push pipeline variable"

  - script: docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD}
    displayName: "Log into docker registry"
    condition: ne(variables.needs_push, 'false')
    env:
      DOCKER_USERNAME: $(DOCKER_USERNAME)
      DOCKER_PASSWORD: $(DOCKER_PASSWORD)

  - template: ../load_images.yml

  - script: docker push derex/forum-$(OPENEDX_VERSION):$(grep __version__ derex/forum/__init__.py |sed 's/[^"]*"//;s/"//')
    condition: ne(variables.needs_push, 'false')
    displayName: "Push $(OPENEDX_VERSION) image"
