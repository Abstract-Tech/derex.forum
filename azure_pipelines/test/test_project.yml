steps:
  - template: ../setup.yml
    parameters:
      AS_PYTHON_PACKAGE: True

  - template: ../load_images.yml

  - script: ddc-services up -d
    displayName: "Start services"

  - script: |
      set -ex
      cd examples/$(OPENEDX_VERSION)/
      derex mysql reset --force
      derex reset-rabbitmq
      derex forum create-index
    displayName: "Prime Mysql, Rabbitmq and Elasticsearch"

  - script: |
      set -ex
      cd examples/$(OPENEDX_VERSION)/
      ddc-project config
      derex settings base
      ddc-project up -d lms forum
    displayName: "Start lms and forum"

  - script: |
      set -ex
      cd examples/$(OPENEDX_VERSION)/
      ddc-project logs
    displayName: "Show logs"

  - script: |
      cd examples/$(OPENEDX_VERSION)/
      WORKERS_READY=$(ddc-project logs forum | grep -c "worker=[0-9] ready")
      until [ $WORKERS_READY -gt 0 ]; do
          echo "Waiting for forum service workers to be ready..."
          echo $(ddc-project logs --tail=1 forum)
          sleep 1
          WORKERS_READY=$(ddc-project logs forum | grep -c "worker=[0-9] ready")
      done
      echo "Forum service workers are ready !"
      echo $(ddc-project logs --tail=5 forum)
      exit 0
    timeoutInMinutes: 1
    displayName: "Test that forum workers are ready"
