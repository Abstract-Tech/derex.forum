steps:
  - script: |
      set -ex
      sudo apt-get remove moby-cli -y
      curl -fsSL https://get.docker.com |sudo bash
      sudo mv /etc/docker/daemon.json /etc/docker/daemon.json.orig
      sudo cat /etc/docker/daemon.json.orig|jq '. + {experimental: true}' |sudo tee /etc/docker/daemon.json
      sudo systemctl restart docker.service
      docker version
      docker buildx create --use
      docker images
    displayName: Replace Microsoft docker with upstream docker and create build context

  - script: sudo apt-get install pixz -y
    displayName: Install pixz

  - template: ../setup.yml

  - script: derex build forum --docker-opts "--cache-to=type=inline --load" $(OPENEDX_VERSION)
    displayName: Build docker image

  - script: |
      set -euxo pipefail;
      docker save $(derex build forum --only-print-image-name $(OPENEDX_VERSION)) \
        | pixz -0 > $forum-$(OPENEDX_VERSION).tar.xz
    condition: eq(variables.JOB_VARIANT, 'Pinned')
    displayName: Save images

  - publish: forum-$(OPENEDX_VERSION).tar.xz
    artifact: forum-$(OPENEDX_VERSION)
    displayName: "Publish docker images as an artifact"
    condition: eq(variables.JOB_VARIANT, 'Pinned')
